<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDCkP7LTzdNcvZhp24rRsQirYDCcrsuvOA",
        authDomain: "assetguard-c8c8c.firebaseapp.com",
        projectId: "assetguard-c8c8c",
        storageBucket: "assetguard-c8c8c.firebasestorage.app",
        messagingSenderId: "717561990429",
        appId: "1:717561990429:web:2b86968c4d3e6ea15ba5f4"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    const status = document.getElementById("status-text");
    const loginForm = document.getElementById("login-form");
    const dashMenu = document.getElementById("dashboard-menu");

    // Track if we just clicked the login button
    let isLoggingIn = false;

    auth.onAuthStateChanged((user) => {
        if (user) {
            // If the user exists but we didn't JUST click login, 
            // it means it's an old "remembered" session we want to ignore.
            if (!isLoggingIn && user.metadata.lastSignInTime === user.metadata.creationTime) {
                 // Allow new users
            } else if (!isLoggingIn) {
                // If it's an old session and we aren't actively logging in, clear it.
                auth.signOut();
                return;
            }

            // UI for Successful Login
            status.innerText = "Welcome, " + user.email;
            status.style.color = "green";
            loginForm.style.display = "none";
            dashMenu.style.display = "block";
            
            setTimeout(() => { 
                if(window.location.pathname.includes("index.html") || window.location.pathname.endsWith("/")) {
                    window.location.href = "sales.html"; 
                }
            }, 1500);

        } else {
            status.innerText = "Please sign in to continue";
            status.style.color = "#666";
            loginForm.style.display = "block";
            dashMenu.style.display = "none";
        }
    });

    function handleLogin() {
        const email = document.getElementById("user").value.trim();
        const pass = document.getElementById("pass").value.trim();
        const btn = document.getElementById("login-btn");

        if(!email || !pass) {
            alert("Please enter credentials.");
            return;
        }

        isLoggingIn = true; // Tell the app we are intentionally logging in
        status.innerText = "Authenticating...";
        btn.disabled = true;

        auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
            .then(() => {
                return auth.signInWithEmailAndPassword(email, pass);
            })
            .catch((error) => {
                isLoggingIn = false;
                status.innerText = "Error: " + error.message;
                status.style.color = "red";
                btn.disabled = false;
            });
    }

    function logout() {
        auth.signOut().then(() => {
            location.reload();
        });
    }
</script>
