<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase History - AssetGuard</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --card: rgba(30, 41, 59, 0.7);
            --text: #f8fafc;
            --accent-blue: #38bdf8;
            --accent-green: #10b981;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 15px;
            padding-bottom: 90px;
        }

        header { padding: 20px 0; }
        h1 { font-size: 1.5rem; margin: 0; }
        .sub { color: #94a3b8; font-size: 0.9rem; }

        .list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }

        .item {
            background: var(--card);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-details h3 { margin: 0; font-size: 1rem; color: var(--accent-blue); }
        .item-details p { margin: 4px 0 0; font-size: 0.85rem; color: #94a3b8; }

        .qty-badge {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .price-text {
            display: block;
            font-weight: 700;
            font-size: 1.1rem;
            margin-top: 5px;
        }

        .footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #1e293b; padding: 20px;
            display: flex; justify-content: space-between;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>

<header>
    <h1>Purchase History</h1>
    <div class="sub">Inventory stock-in logs</div>
</header>

<div id="purchaseList" class="list">
    <div style="text-align:center; padding:40px; color:#64748b;">Loading records...</div>
</div>

<div class="footer">
    <span style="color:#94a3b8">Total Stock Value</span>
    <span id="totalValue" style="font-weight:800; color:var(--accent-green); font-size:1.2rem;">$0.00</span>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDCkP7LTzdNcvZhp24rRsQirYDCcrsuvOA",
        authDomain: "assetguard-c8c8c.firebaseapp.com",
        projectId: "assetguard-c8c8c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    firebase.auth().onAuthStateChanged(user => {
        if (!user) window.parent.location.href = "index.html";
        else loadPurchases();
    });

    function loadPurchases() {
        // NOTE: Make sure your collection name is exactly "purchases" or "stock_in"
        db.collection("purchases").orderBy("timestamp", "desc").onSnapshot(snapshot => {
            const listEl = document.getElementById('purchaseList');
            const totalEl = document.getElementById('totalValue');
            
            if (snapshot.empty) {
                listEl.innerHTML = '<div style="text-align:center; padding:40px;">No purchases found.</div>';
                return;
            }

            let html = '';
            let grandTotal = 0;

            snapshot.forEach(doc => {
                const data = doc.data();
                const totalCost = Number(data.costPrice || 0) * Number(data.quantity || 0);
                grandTotal += totalCost;

                html += `
                    <div class="item">
                        <div class="item-details">
                            <h3>${data.itemName || 'Unknown Item'}</h3>
                            <p>${data.date} â€¢ ${data.supplier || 'No Supplier'}</p>
                        </div>
                        <div style="text-align:right">
                            <span class="qty-badge">+ ${data.quantity} units</span>
                            <span class="price-text">$${totalCost.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });

            listEl.innerHTML = html;
            totalEl.innerText = `$${grandTotal.toLocaleString()}`;
        });
    }
</script>
</body>
</html>
