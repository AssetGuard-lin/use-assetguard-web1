<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Sales Terminal - AssetGuard Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0072CE; --dark: #001A35; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; }
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 15px; background: #fff; color: #1f2937; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid #f0f2f5; }
        
        h2 { text-align: center; color: var(--dark); margin-bottom: 20px; font-weight: 700; }
        label { display: block; margin-top: 10px; font-weight: 700; color: var(--dark); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .input-wrapper { position: relative; display: flex; align-items: center; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 2px solid #f0f2f5; border-radius: 10px; box-sizing: border-box; background: #f9fbff; font-family: inherit; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--primary); background: #fff; outline: none; }
        input:disabled { background: #eef4ff; color: #5c6b89; cursor: not-allowed; border-color: #d1d9e6; }
        input.editing-active { border-color: var(--warning); background: #fffdf5; }

        .btn-pen { position: absolute; right: 10px; top: 12px; background: #fff; border: 1px solid #cbd5e0; border-radius: 5px; padding: 3px 8px; font-size: 12px; cursor: pointer; color: var(--primary); display: none; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #fdfeff; padding: 15px; border-radius: 15px; border: 1px solid #edf2f7; margin-bottom: 15px; }
        .item-picker { background: #fff; padding: 15px; border-radius: 15px; border: 2px solid #f0f2f5; margin-bottom: 20px; }
        
        .stock-tag { float: right; font-size: 10px; background: #eef4ff; color: var(--primary); padding: 2px 8px; border-radius: 5px; }

        .btn-main { color: white; border: none; padding: 14px; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 15px; transition: 0.3s; }
        .btn-add { background: var(--dark); }
        .btn-save { background: var(--warning); display: none; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th { text-align: left; padding: 12px 8px; color: #64748b; border-bottom: 2px solid #f1f5f9; background: #f8fafc; }
        td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; }
        
        .row-edit { color: var(--primary); cursor: pointer; font-size: 16px; }

        .totals-display { background: var(--dark); color: white; padding: 20px; border-radius: 15px; margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn-sync { background: linear-gradient(135deg, var(--primary), #00d2ff); color: white; border: none; padding: 18px; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 15px; font-size: 16px; }
        
        #status { text-align: center; margin-top: 15px; font-size: 13px; min-height: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üõí Sales Terminal</h2>
    
    <div class="form-grid">
        <div>
            <label>Customer Name</label>
            <div class="input-wrapper">
                <input type="text" id="business_name" value="Walk-in Customer" 
                       onfocus="if(this.value=='Walk-in Customer')this.value='';" 
                       onblur="if(this.value=='')this.value='Walk-in Customer';">
                <button id="edit_name_btn" class="btn-pen" onclick="startNameEdit()">‚úèÔ∏è</button>
            </div>
        </div>
        <div>
            <label>Payment Method</label>
            <select id="payment_status">
                <option value="Cash">Cash</option>
                <option value="M-Pesa">M-Pesa</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Credit">Credit</option>
            </select>
        </div>
    </div>

    <div class="item-picker">
        <span id="stock_display" class="stock-tag">STOCK: --</span>
        <label>Select Stock Item</label>
        <select id="product_stock" onchange="updateStockDisplay()">
            <option value="">-- Choose Item --</option>
            <option value="Aseton" data-stock="50">Aseton</option>
            <option value="Bitumen 5L" data-stock="12">Bitumen 5L</option>
            <option value="Greenwood 20L" data-stock="8">Greenwood 20L</option>
            <option value="Paint 4L" data-stock="20">Paint 4L</option>
            <option value="RC2" data-stock="15">RC2</option>
        </select>

        <div style="display: flex; gap: 10px; margin-top: 5px;">
            <div style="flex: 2;">
                <label>Unit Sale Price</label>
                <input type="number" id="price" placeholder="0.00">
            </div>
            <div style="flex: 1;">
                <label>Qty</label>
                <input type="number" id="quantity" value="1" oninput="validateStock()">
            </div>
            <div style="flex: 1;">
                <label>VAT %</label>
                <input type="number" id="vat_rate" value="16">
            </div>
        </div>
        
        <button id="add-btn" class="btn-main btn-add" onclick="addToCart()">Add to Cart</button>
        <button id="save-btn" class="btn-main btn-save" onclick="saveEdit()">Update Changes</button>
    </div>

    <div class="cart-section">
        <table>
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Item</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Total</th>
                    <th style="width: 40px;">Edit</th>
                </tr>
            </thead>
            <tbody id="cart-body"></tbody>
        </table>

        <div class="totals-display">
            <span style="font-size: 12px; opacity: 0.8;">TOTAL PAYABLE</span>
            <span id="grand-total" style="font-size: 24px; font-weight: 700;">KES 0.00</span>
        </div>

        <button class="btn-sync" onclick="syncWithApp()">Confirm Sale & Update Stock</button>
        <p id="status"></p>
    </div>
</div>

<script>
    let cart = [];
    let editIndex = null;
    let isEditingName = false;

    function updateStockDisplay() {
        const select = document.getElementById('product_stock');
        const option = select.options[select.selectedIndex];
        const stock = option.getAttribute('data-stock');
        const display = document.getElementById('stock_display');
        display.innerText = stock ? `STOCK: ${stock}` : "STOCK: --";
    }

    function validateStock() {
        const select = document.getElementById('product_stock');
        const option = select.options[select.selectedIndex];
        if(!option.value) return;
        const available = parseInt(option.getAttribute('data-stock'));
        const requested = parseInt(document.getElementById('quantity').value);
        if(requested > available) {
            alert("Insufficient Stock!");
            document.getElementById('quantity').value = available;
        }
    }

    function addToCart() {
        const bizField = document.getElementById('business_name');
        const select = document.getElementById('product_stock');
        const option = select.options[select.selectedIndex];
        const prc = parseFloat(document.getElementById('price').value);
        const qty = parseInt(document.getElementById('quantity').value);
        const vRate = parseFloat(document.getElementById('vat_rate').value);

        if(!option.value || isNaN(prc) || qty < 1) {
            alert("Complete all fields."); return;
        }

        // Deduct from local UI stock
        const currentStock = parseInt(option.getAttribute('data-stock'));
        option.setAttribute('data-stock', currentStock - qty);
        updateStockDisplay();

        bizField.disabled = true;
        document.getElementById('edit_name_btn').style.display = 'block';

        const subtotal = prc * qty;
        const lineTotal = subtotal + (subtotal * (vRate / 100));

        cart.push({
            customer: bizField.value, 
            payment: document.getElementById('payment_status').value, 
            product: option.value,
            price: prc, quantity: qty, vatRate: vRate,
            total: lineTotal.toFixed(2)
        });

        updateUI();
        clearInputs();
    }

    function startNameEdit() {
        const field = document.getElementById('business_name');
        field.disabled = false;
        field.classList.add('editing-active');
        field.focus();
        isEditingName = true;
        toggleButtons(true);
        document.getElementById('edit_name_btn').style.display = 'none';
    }

    function saveEdit() {
        if(isEditingName) {
            const newName = document.getElementById('business_name').value;
            cart.forEach(item => item.customer = newName);
            document.getElementById('business_name').disabled = true;
            document.getElementById('business_name').classList.remove('editing-active');
            isEditingName = false;
            document.getElementById('edit_name_btn').style.display = 'block';
        } else if(editIndex !== null) {
            // Restore stock before replacing
            const oldItem = cart[editIndex];
            const select = document.getElementById('product_stock');
            for(let opt of select.options) {
                if(opt.value === oldItem.product) {
                    opt.setAttribute('data-stock', parseInt(opt.getAttribute('data-stock')) + oldItem.quantity);
                    break;
                }
            }
            cart.splice(editIndex, 1);
            addToCart();
            editIndex = null;
        }
        updateUI();
        toggleButtons(false);
    }

    function toggleButtons(isEditing) {
        document.getElementById('add-btn').style.display = isEditing ? 'none' : 'block';
        document.getElementById('save-btn').style.display = isEditing ? 'block' : 'none';
    }

    function clearInputs() {
        document.getElementById('product_stock').value = "";
        document.getElementById('price').value = "";
        document.getElementById('quantity').value = "1";
        updateStockDisplay();
    }

    function editItem(index) {
        const item = cart[index];
        editIndex = index;
        isEditingName = false;
        document.getElementById('product_stock').value = item.product;
        document.getElementById('price').value = item.price;
        document.getElementById('quantity').value = item.quantity;
        document.getElementById('vat_rate').value = item.vatRate;
        updateStockDisplay();
        toggleButtons(true);
        window.scrollTo(0,0);
    }

    function updateUI() {
        const tbody = document.getElementById('cart-body');
        tbody.innerHTML = "";
        let runningTotal = 0;
        cart.forEach((item, index) => {
            runningTotal += parseFloat(item.total);
            tbody.innerHTML += `<tr>
                <td>${item.customer}</td>
                <td>${item.product}</td>
                <td>${item.quantity}</td>
                <td>${item.price}</td>
                <td style="font-weight:700;">${item.total}</td>
                <td><span class="row-edit" onclick="editItem(${index})">‚úèÔ∏è</span></td>
            </tr>`;
        });
        document.getElementById('grand-total').innerText = "KES " + runningTotal.toLocaleString();
    }

    function syncWithApp() {
        if(cart.length === 0) return;
        let finalData = cart.map(item => `${item.customer}:${item.payment}:${item.product}:${item.price}:${item.quantity}:${item.total}`).join("|");
        
        if (window.AppInventor) {
            window.AppInventor.setWebViewString(finalData);
            document.getElementById('status').innerHTML = "‚úÖ Sale Processed & Stock Deducted!";
            cart = [];
            updateUI();
            document.getElementById('business_name').value = "Walk-in Customer";
        } else {
            console.log("Sync String:", finalData);
            alert("Syncing simulated.");
        }
    }
</script>
</body>
</html>
